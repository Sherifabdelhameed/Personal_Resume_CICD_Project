on:
  push:
    branches:  
      - main
jobs:
  docker_build_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.0.0
        
      - name: Authenticate Dockerhub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Dockerfile Build
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/my-resume:latest . 

      - name: Dockerhub Push
        run: docker push ${{ secrets.DOCKER_USERNAME }}/my-resume:latest
        
  terraform_infra_creation:
    runs-on: ubuntu-latest
    needs: docker_build_and_push
    outputs:
      web_app_name: ${{ steps.terraform.outputs.web_app_name }}
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Terraform Setup
        uses: hashicorp/setup-terraform@v2.0.3
        with:
          terraform_wrapper: false
      
      - name: Terraform Directory Initialization
        working-directory: Terraform
        run: terraform init

      - name: Terraform Formatting
        working-directory: Terraform
        run: terraform fmt

      - name: Terraform Validation
        working-directory: Terraform
        run: terraform validate

      - name: Terraform Destroy
        working-directory: Terraform
        run: terraform destroy -auto-approve

      - name: Terraform Apply
        id: terraform
        working-directory: Terraform
        run: |
          terraform apply -auto-approve
          echo "web_app_name=$(terraform output -raw web_app_name 2>/dev/null || echo 'my-dockerapp')" >> $GITHUB_OUTPUT
